#!/bin/bash

# MIT License:    Copyright (c) 2025 Eryk J.

# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:

# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.

# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.


echo -e "\nThis is an installation/update script generated by nebulder (https://github.com/erykjj/nebulder)\nfor automating the deployment of a Nebula network device under Linux with systemd\n"

if [ "$(id -u)" != "0" ]; then
 echo -e "* Because of the high-level access required to execute these commands,\n  this script needs to be run as root\n"
 exit 1
fi

if [[ ! -x "nebula" ]]; then
  if [[ ! -x "/usr/bin/nebula" ]]; then 
    echo -e "* nebula binary not found in /usr/bin!\n  Ensure you download the latest nebula binary\n  from https://github.com/slackhq/nebula/releases/latest\n"
    exit 1
  fi
fi

# for renewal/redeployment: remove previous keys/config - if any
if [[ -d "/etc/nebula/@@tun_device@@" ]]; then
  echo "* Cleaning up previous settings"
  systemctl stop nebula_@@tun_device@@-update.timer 2>/dev/null || true
  systemctl stop nebula_@@tun_device@@-update.service 2>/dev/null || true
  systemctl stop nebula_@@tun_device@@.service 2>/dev/null || true
  systemctl disable nebula_@@tun_device@@-update.timer 2>/dev/null || true
  systemctl disable nebula_@@tun_device@@-update.service 2>/dev/null || true
  systemctl disable nebula_@@tun_device@@.service 2>/dev/null || true
  rm -f /etc/systemd/system/nebula_@@tun_device@@.service \
        /etc/systemd/system/nebula_@@tun_device@@-update.service \
        /etc/systemd/system/nebula_@@tun_device@@-update.timer 2>/dev/null || true
  systemctl daemon-reload 2>/dev/null || true
  echo "  Services stopped and disabled"
  rm -rf /etc/nebula/@@tun_device@@
  echo -e "  Previous key/config files removed\n"
else
  echo -e "* Creating 'nebula' user for binary and key/config file access\n"
  useradd -rM nebula > /dev/null 2>&1
fi

echo -e "* Installing nebula binary and update script to /usr/lib/nebula/"
mkdir -p /usr/lib/nebula
chmod 750 /usr/lib/nebula
chown root:nebula /usr/lib/nebula
if [[ -x "nebula" ]]; then
  install -m 750 nebula /usr/lib/nebula/nebula
  chown root:nebula /usr/lib/nebula/nebula
  setcap cap_net_admin=+pe /usr/lib/nebula/nebula 2>/dev/null || true
  echo "  Binary installed"
fi
install -m 740 nebula_@@tun_device@@-update.sh /usr/lib/nebula/nebula_@@tun_device@@-update.sh
chown root:nebula /usr/lib/nebula/nebula_@@tun_device@@-update.sh
echo -e "  Update script installed\n"

echo "* Putting key/config files in /etc/nebula/@@tun_device@@"
mkdir -p /etc/nebula/@@tun_device@@
cp -t /etc/nebula/@@tun_device@@ host.* ca.crt config.yaml version node
echo "  Files copied"
chown -R nebula:nebula /etc/nebula/@@tun_device@@
chmod 600 /etc/nebula/@@tun_device@@/host.* /etc/nebula/@@tun_device@@/ca.crt
chmod 644 /etc/nebula/@@tun_device@@/config.yaml
chmod 644 /etc/nebula/@@tun_device@@/version
chmod 644 /etc/nebula/@@tun_device@@/node
echo -e "  Permissions set\n"

echo "* Setting up systemd unit files in /etc/systemd/system/"
cp nebula_@@tun_device@@.service nebula_@@tun_device@@-update.service nebula_@@tun_device@@-update.timer /etc/systemd/system/
systemctl daemon-reload
systemctl enable nebula_@@tun_device@@.service > /dev/null 2>&1
echo "  nebula_@@tun_device@@.service enabled"
systemctl start nebula_@@tun_device@@.service
echo "  nebula_@@tun_device@@.service started"
systemctl enable nebula_@@tun_device@@-update.service > /dev/null 2>&1
echo "  nebula_@@tun_device@@-update.service enabled"
systemctl enable nebula_@@tun_device@@-update.timer > /dev/null 2>&1
echo "  nebula_@@tun_device@@-update.timer enabled"
systemctl start nebula_@@tun_device@@-update.timer
echo "  nebula_@@tun_device@@-update.timer started"

echo -e "  nebula_@@tun_device@@ service status:"
if systemctl is-active --quiet nebula_@@tun_device@@.service; then
  echo "    ✓ nebula_@@tun_device@@.service: active"
else
  echo "    ✗ nebula_@@tun_device@@.service: inactive"
fi

if systemctl is-active --quiet nebula_@@tun_device@@-update.timer; then
  echo "    ✓ nebula_@@tun_device@@-update.timer: active"
  next_run=$(systemctl show nebula_@@tun_device@@-update.timer -p NextElapseUSecRealtime --value 2>/dev/null)
  if [[ -n "$next_run" ]] && [[ "$next_run" != "0" ]]; then
    echo "    Next update: $(date -d "@$((next_run/1000000))" '+%Y-%m-%d %H:%M')"
  fi
else
  echo "    ✗ nebula_@@tun_device@@-update.timer: inactive"
fi
echo ""

echo "* If the device is a lighthouse, you may also need to add a rule to your firewall"
echo "  to allow traffic to the @@tun_device@@ network device port. Example:"
echo "  # sudo ufw allow 4242/udp"
echo -e "  # sudo ufw reload\n"

echo -e "Done. If there were no errors, you can remove this deployment package\n"

exit 0
#!/bin/bash

echo -e "\nThis is an installation script generated by nebulder (https://github.com/erykjj/nebulder)\nfor automating the deployment of a nebula network device under Linux with systemd\n"

echo -e "Because of the high-level access required to execute these commands,\nthis script needs to be run a root\n"

echo -e "\nEnsure you have the latest nebula binary in /usr/bin\n"

echo -e "* Creating 'nebula' user for binary and key/config file access\n"
useradd -rM nebula
chown nebula:nebula /usr/bin/nebula
chmod 770 /usr/bin/nebula
setcap cap_net_admin=+pe /usr/bin/nebula

echo "* Putting key/config files in /etc/nebula/@@tun_device@@"
mkdir -p /etc/nebula/@@tun_device@@
cp -t /etc/nebula/@@tun_device@@ host.* ca.crt config.yaml
echo "  Files copied"
chown -R nebula:nebula /etc/nebula/@@tun_device@@
chmod 600 /etc/nebula/@@tun_device@@/*
chmod 644 /etc/nebula/@@tun_device@@/config.yaml
echo -e "  Permissions changed to rw------- (600)\n"

echo "* Setting up systemd: /etc/systemd/system/nebula_@@tun_device@@.service"
cp nebula_@@tun_device@@.service /etc/systemd/system/
systemctl daemon-reload
systemctl enable nebula_@@tun_device@@.service
echo "  Service enabled"
systemctl start nebula_@@tun_device@@.service
echo "  Service started"
echo -e "  Check status with 'systemctl status nebula_@@tun_device@@.service'\n"

echo "* If the device is a lighthouse, you may also need to add a rule to your firewall"
echo "  to allow traffic to the @@tun_device@@ network device port. Example:"
echo "  # sudo ufw allow 4242/udp"
echo -e "  # sudo ufw reload\n"

echo -e "Done. If there were no errors, you can remove this script and the other files\n"

exit 0